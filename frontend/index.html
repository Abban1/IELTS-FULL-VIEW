<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Tests</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: system-ui, -apple-system, sans-serif; padding:20px; background:#f5f5f5; }
.container { max-width:1200px; margin:0 auto; }
h1 { margin-bottom:20px; color:#333; }
.controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; background:#fff; padding:15px; border-radius:4px; }
select, input, button { padding:8px 12px; border:1px solid #ddd; border-radius:4px; font-size:14px; }
input[type="number"] { width:100px; }
button { cursor:pointer; background:#007bff; color:#fff; border:none; }
button:hover { background:#0056b3; }
.generate-btn { background:#28a745; }
.generate-btn:hover { background:#218838; }
.delete-btn { background:#dc3545; padding:4px 8px; font-size:12px; }
.delete-btn:hover { background:#c82333; }
table { width:100%; background:#fff; border-radius:4px; overflow:hidden; }
th, td { padding:10px; text-align:left; border-bottom:1px solid #eee; }
th { background:#f8f9fa; font-weight:600; }
tr:hover { background:#f8f9fa; }
.view-btn { background:#17a2b8; padding:4px 8px; font-size:12px; margin-right:5px; }
.view-btn:hover { background:#138496; }
.pagination { margin:15px 0; text-align:center; }
.pagination button { margin:0 5px; }
.pagination button:disabled { opacity:0.5; cursor:not-allowed; }
#testContent { background:#fff; padding:20px; border-radius:4px; margin-top:20px; white-space:pre-wrap; }
.page-size-group { display:flex; gap:5px; align-items:center; }
</style>
</head>
<body>
<div class="container">
<h1>IELTS Tests Viewer</h1>

<div class="controls">
<select id="module">
<option value="reading">Reading</option>
<option value="writing">Writing</option>
<option value="listening">Listening</option>
<option value="speaking">Speaking</option>
</select>
<input type="text" id="search" placeholder="Search...">
<input type="date" id="from">
<input type="date" id="to">
<select id="sort">
<option value="desc">Newest First</option>
<option value="asc">Oldest First</option>
</select>
<div class="page-size-group">
<select id="pageSize">
<option value="5">5 per page</option>
<option value="10" selected>10 per page</option>
<option value="20">20 per page</option>
<option value="50">50 per page</option>
<option value="100">100 per page</option>
<option value="custom">Custom</option>
</select>
<input type="number" id="customPageSize" placeholder="Custom" min="1" max="500" style="display:none;">
</div>
<button id="searchBtn">Filter</button>
<button class="generate-btn" id="generate">Generate Test</button>
</div>

<table>
<thead><tr><th>Name</th><th>ID</th><th>Level/Type</th><th>Created</th><th>Actions</th></tr></thead>
<tbody id="tbody"></tbody>
</table>

<div class="pagination">
<button id="prev">Prev</button>
<span id="page"></span>
<button id="next">Next</button>
</div>

<div id="testContent">Select a test to view</div>
</div>

<script>
const $ = id => document.getElementById(id);
let p = 1, mod, tbody = $('tbody'), content = $('testContent');

// Show/hide custom input based on selection
$('pageSize').onchange = function() {
    if(this.value === 'custom') {
        $('customPageSize').style.display = 'block';
        $('customPageSize').focus();
    } else {
        $('customPageSize').style.display = 'none';
        p = 1;
        load();
    }
};

// Load when custom value is entered
$('customPageSize').oninput = function() {
    if(this.value && this.value > 0) {
        p = 1;
        load();
    }
};

// Also trigger on Enter key
$('customPageSize').onkeypress = function(e) {
    if(e.key === 'Enter' && this.value > 0) {
        p = 1;
        load();
    }
};

async function load(){
    mod = $('module').value;
    
    // Get page size from dropdown or custom input
    let pageSize;
    if($('pageSize').value === 'custom') {
        pageSize = $('customPageSize').value || 10;
        if(pageSize < 1) pageSize = 10;
        if(pageSize > 500) pageSize = 500; // Max limit
    } else {
        pageSize = $('pageSize').value;
    }
    
    const params = new URLSearchParams({page:p, page_size:pageSize});
    if($('search').value) params.append('search', $('search').value);
    if($('from').value) params.append('from_date', $('from').value);
    if($('to').value) params.append('to_date', $('to').value);
    params.append('sort_by', $('sort').value);

    const res = await fetch(`http://127.0.0.1:8000/${mod}/tests?${params}`);
    const {tests, total_pages} = await res.json();

    tbody.innerHTML = tests.length ? tests.map(t => `
        <tr>
            <td>${t.name||'N/A'}</td>
            <td>${t.id}</td>
            <td>${t.level||t.task_type||'N/A'}</td>
            <td>${new Date(t.created_at).toLocaleString()}</td>
            <td>
                <button class="view-btn" onclick="view('${t.id}')">View</button>
                <button class="delete-btn" onclick="del('${t.id}')">Delete</button>
            </td>
        </tr>
    `).join('') : '<tr><td colspan="5">No tests found</td></tr>';

    $('page').textContent = `Page ${p} of ${total_pages||1}`;
    $('prev').disabled = p <= 1;
    $('next').disabled = p >= total_pages;
}

async function view(id){
    const res = await fetch(`http://127.0.0.1:8000/${mod}/tests/${id}`);
    content.textContent = await res.text();
}

async function del(id){
    if(!confirm('Delete this test?')) return;
    await fetch(`http://127.0.0.1:8000/${mod}/tests/${id}`, {method:'DELETE'});
    load();
}

$('prev').onclick = () => { if(p>1) p--, load(); };
$('next').onclick = () => { p++; load(); };
$('searchBtn').onclick = () => { p=1; load(); };
$('sort').onchange = () => { p=1; load(); };
$('module').onchange = () => { p=1; $('search').value=''; $('from').value=''; $('to').value=''; load(); };

$('generate').onclick = async () => {
    let url = `http://127.0.0.1:8000/${mod}/generate`;
    if(mod === 'writing') {
        const type = prompt('Task type (task1/task2):', 'task1');
        if(!type) return;
        url += `?task_type=${type}`;
    }
    const res = await fetch(url);
    content.textContent = await res.text();
    p=1; load();
};

load();
</script>
</body>
</html>