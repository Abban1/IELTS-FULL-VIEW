<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Tests Viewer</title>
<style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { color: #2c3e50; }
    select, input, button { padding: 8px 12px; margin: 5px 0; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
    th { background: #3498db; color: white; }
    tr:nth-child(even) { background: #ecf0f1; }
    tr:hover { background: #d1ecf1; }
    button.delete-btn { background: #e74c3c; color: white; border: none; cursor: pointer; padding: 6px 12px; }
    button.delete-btn:hover { background: #c0392b; }
    #testContent { margin-top: 30px; white-space: pre-wrap; padding: 15px; background: #fff; border: 1px solid #ccc; }
    button.generate-btn { background: #2ecc71; color: white; border: none; cursor: pointer; padding: 8px 16px; }
    button.generate-btn:hover { background: #27ae60; }
    .pagination { margin-top: 15px; }
    .pagination button { padding: 6px 12px; margin-right: 5px; }
    .pagination button:disabled { background: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<h1>IELTS Tests Viewer</h1>

<label for="module">Choose Module:</label>
<select id="module">
    <option value="reading">Reading</option>
    <option value="writing">Writing</option>
    <option value="listening">Listening</option>
    <option value="speaking">Speaking</option>
</select>

<input type="text" id="searchInput" placeholder="Search by name or ID">
<button id="searchBtn">Search</button>

<button class="generate-btn" id="generateTest">Generate New Test</button>

<table id="testsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>ID</th>
            <th>Level / Type</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="pagination">
    <button id="prevPage">Prev</button>
    <span id="pageInfo"></span>
    <button id="nextPage">Next</button>
</div>

<div id="testContent">Click a test above to view its content here.</div>

<script>
const moduleSelect = document.getElementById("module");
const testsTableBody = document.querySelector("#testsTable tbody");
const testContent = document.getElementById("testContent");
const generateBtn = document.getElementById("generateTest");
const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const prevBtn = document.getElementById("prevPage");
const nextBtn = document.getElementById("nextPage");
const pageInfo = document.getElementById("pageInfo");

let currentPage = 1;
let pageSize = 10;
let currentSearch = "";
let totalPages = 1;

async function fetchTests() {
    const module = moduleSelect.value;
    testsTableBody.innerHTML = "";
    testContent.textContent = "Loading tests...";

    const params = new URLSearchParams({ page: currentPage, page_size: pageSize });
    if (currentSearch) params.append("search", currentSearch);

    try {
        const res = await fetch(`http://127.0.0.1:8000/${module}/tests?${params.toString()}`);
        const data = await res.json();

        totalPages = data.total_pages || 1;

        // Ensure currentPage is within bounds
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;

        // Update table
        testsTableBody.innerHTML = "";
        if (data.tests.length === 0) {
            testsTableBody.innerHTML = `<tr><td colspan="5">No tests found.</td></tr>`;
        } else {
            data.tests.forEach(test => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${test.name || "N/A"}</td>
                    <td>${test.id}</td>
                    <td>${test.level || test.task_type || "N/A"}</td>
                    <td>${new Date(test.created_at).toLocaleString()}</td>
                    <td>
                        <button class="view-btn">View</button>
                        <button class="delete-btn">Delete</button>
                    </td>
                `;

                // View Test
                tr.querySelector(".view-btn").addEventListener("click", async () => {
                    const endpoint = `http://127.0.0.1:8000/${module}/tests/${test.id}`;
                    const res = await fetch(endpoint);
                    const content = await res.text();
                    testContent.textContent = content;
                });

                // Delete Test
                tr.querySelector(".delete-btn").addEventListener("click", async () => {
                    if (confirm("Are you sure you want to delete this test?")) {
                        const res = await fetch(`http://127.0.0.1:8000/${module}/tests/${test.id}`, { method: "DELETE" });
                        const result = await res.json();
                        alert(result.message);
                        fetchTests();
                    }
                });

                testsTableBody.appendChild(tr);
            });
        }

        // Update pagination
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        testContent.textContent = "Click a test above to view its content here.";
    } catch (error) {
        console.error(error);
        testContent.textContent = "Error loading tests.";
    }
}

// Pagination buttons
prevBtn.addEventListener("click", () => {
    if (currentPage > 1) { currentPage--; fetchTests(); }
});
nextBtn.addEventListener("click", () => {
    if (currentPage < totalPages) { currentPage++; fetchTests(); }
});

// Generate new test
generateBtn.addEventListener("click", async () => {
    const module = moduleSelect.value;
    let endpoint = `http://127.0.0.1:8000/${module}/generate`;

    if (module === "writing") {
        const task_type = prompt("Enter task type (task1 or task2):", "task1");
        if (!task_type) return alert("Task type is required!");
        endpoint += `?task_type=${task_type}`;
    }

    try {
        const res = await fetch(endpoint);
        const content = await res.text();
        testContent.textContent = content;
        currentPage = 1;
        fetchTests();
    } catch (error) {
        console.error(error);
        testContent.textContent = "Error generating test.";
    }
});

// Search
searchBtn.addEventListener("click", () => {
    currentSearch = searchInput.value.trim();
    currentPage = 1;
    fetchTests();
});

// Module change
moduleSelect.addEventListener("change", () => {
    currentPage = 1;
    currentSearch = "";
    fetchTests();
});

// Initial load
fetchTests();
</script>

</body>
</html>
