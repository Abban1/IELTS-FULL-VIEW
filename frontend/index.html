<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Tests Viewer</title>
<style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 20px; }
    h1 { color: #2c3e50; }
    select, button { padding: 8px 12px; margin: 5px 0; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
    th { background: #3498db; color: white; }
    tr:nth-child(even) { background: #ecf0f1; }
    tr:hover { background: #d1ecf1; }
    button.delete-btn { background: #e74c3c; color: white; border: none; cursor: pointer; padding: 6px 12px; }
    button.delete-btn:hover { background: #c0392b; }
    #testContent { margin-top: 30px; white-space: pre-wrap; padding: 15px; background: #fff; border: 1px solid #ccc; }
    button.generate-btn { background: #2ecc71; color: white; border: none; cursor: pointer; padding: 8px 16px; }
    button.generate-btn:hover { background: #27ae60; }
</style>
</head>
<body>

<h1>IELTS Tests Viewer</h1>

<label for="module">Choose Module:</label>
<select id="module">
    <option value="reading">Reading</option>
    <option value="writing">Writing</option>
    <option value="listening">Listening</option>
    <option value="speaking">Speaking</option>
</select>

<button class="generate-btn" id="generateTest">Generate New Test</button>

<table id="testsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>ID</th>
            <th>Level / Type</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="testContent">Click a test above to view its content here.</div>

<script>
const moduleSelect = document.getElementById("module");
const testsTableBody = document.querySelector("#testsTable tbody");
const testContent = document.getElementById("testContent");
const generateBtn = document.getElementById("generateTest");

async function fetchTests() {
    const module = moduleSelect.value;
    testsTableBody.innerHTML = "";
    testContent.textContent = "Loading tests...";

    try {
        const res = await fetch(`http://127.0.0.1:8000/${module}/tests`);
        const data = await res.json();
        testContent.textContent = "Click a test above to view its content here.";

        data.forEach(test => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${test.name || "N/A"}</td>
                <td>${test.id}</td>
                <td>${test.level || test.task_type || "N/A"}</td>
                <td>${new Date(test.created_at).toLocaleString()}</td>
                <td>
                    <button class="view-btn">View</button>
                    <button class="delete-btn">Delete</button>
                </td>
            `;

            // View Test
            tr.querySelector(".view-btn").addEventListener("click", async () => {
                const endpoint = `http://127.0.0.1:8000/${module}/tests/${test.id}`;
                const res = await fetch(endpoint);
                const content = await res.text();
                testContent.textContent = content;
            });

            // Delete Test
            tr.querySelector(".delete-btn").addEventListener("click", async () => {
                if (confirm("Are you sure you want to delete this test?")) {
                    const res = await fetch(`http://127.0.0.1:8000/${module}/tests/${test.id}`, { method: "DELETE" });
                    const result = await res.json();
                    alert(result.message);
                    fetchTests(); // refresh table
                }
            });

            testsTableBody.appendChild(tr);
        });

    } catch (error) {
        console.error(error);
        testContent.textContent = "Error loading tests.";
    }
}

// Generate new test
generateBtn.addEventListener("click", async () => {
    const module = moduleSelect.value;
    let endpoint = `http://127.0.0.1:8000/${module}/generate`;

    // For Writing, we need to add task_type parameter
    if (module === "writing") {
        const task_type = prompt("Enter task type (task1 or task2):", "task1");
        if (!task_type) return alert("Task type is required!");
        endpoint += `?task_type=${task_type}`;
        fetchTests();
    }

    try {
        const res = await fetch(endpoint);
        const content = await res.text();
        testContent.textContent = content;
    } catch (error) {
        console.error(error);
        testContent.textContent = "Error generating test.";
    }
});

moduleSelect.addEventListener("change", fetchTests);

// Initial load
fetchTests();
</script>

</body>
</html>
